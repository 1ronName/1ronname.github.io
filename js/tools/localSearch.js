let isFetched=false;let cachedData=[];let cachedPath=null;let isXml=true;let didInit=false;let warnedMissing=false;const resolveSearchPath=()=>{const e=config.path;if(!e){return null}let t=e;isXml=true;if(t.length===0){t="search.xml"}else if(t.endsWith("json")){isXml=false}cachedPath=t;return t};const ensureSearchPath=()=>cachedPath||resolveSearchPath();const normalizeData=e=>{return e.filter(e=>e.title).map(e=>{e.title=e.title.trim();e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"";e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/");return e})};const fetchData=()=>{if(isFetched||!cachedPath){return}fetch(config.root+cachedPath).then(e=>e.text()).then(e=>{isFetched=true;cachedData=isXml?[...(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("entry")].map(e=>{return{title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent}}):JSON.parse(e);cachedData=normalizeData(cachedData);const t=document.querySelector("#no-result");if(t){t.innerHTML='<i class="fa-solid fa-magnifying-glass fa-5x"></i>'}}).catch(e=>{console.error("Failed to load search data:",e)})};const getSearchDom=()=>({searchInputDom:document.querySelector(".search-input"),resultContent:document.getElementById("search-result"),overlay:document.querySelector(".search-pop-overlay")});const closePopup=()=>{const{overlay:e}=getSearchDom();if(!e){return}document.body.style.overflow="";e.classList.remove("active")};const openPopup=()=>{const{overlay:e,searchInputDom:t}=getSearchDom();if(!e||!t){return}document.body.style.overflow="hidden";e.classList.add("active");setTimeout(()=>t.focus(),500);if(!isFetched){fetchData()}};const getIndexByWord=(e,t,n)=>{const r=e.length;if(r===0)return[];let s=0;let o=[];const a=[];if(!n){t=t.toLowerCase();e=e.toLowerCase()}while((o=t.indexOf(e,s))>-1){a.push({position:o,word:e});s=o+r}return a};const mergeIntoSlice=(e,t,n,r)=>{let s=n[n.length-1];let{position:o,word:a}=s;const i=[];let l=0;while(o+a.length<=t&&n.length!==0){if(a===r){l++}i.push({position:o,length:a.length});const c=o+a.length;n.pop();for(let e=n.length-1;e>=0;e--){s=n[e];o=s.position;a=s.word;if(c<=o){break}else{n.pop()}}}return{hits:i,start:e,end:t,searchTextCount:l}};const highlightKeyword=(n,e)=>{let r="";let s=e.start;e.hits.forEach(e=>{r+=n.substring(s,e.position);const t=e.position+e.length;r+=`<b class="search-keyword">${n.substring(e.position,t)}</b>`;s=t});r+=n.substring(s,e.end);return r};const renderSearchResult=e=>{if(!isFetched||!e){return}const{resultContent:n}=getSearchDom();if(!n){return}const f=e.value.trim().toLowerCase();const m=f.split(/[-\s]+/);if(m.length>1){m.push(f)}const w=[];if(f.length>0){cachedData.forEach(({title:e,content:r,url:s})=>{const t=e.toLowerCase();const n=r.toLowerCase();let o=[];let a=[];let i=0;m.forEach(e=>{o=o.concat(getIndexByWord(e,t,false));a=a.concat(getIndexByWord(e,n,false))});if(o.length>0||a.length>0){const l=o.length+a.length;[o,a].forEach(e=>{e.sort((e,t)=>{if(t.position!==e.position){return t.position-e.position}return e.word.length-t.word.length})});const c=[];if(o.length!==0){const u=mergeIntoSlice(0,e.length,o,f);i+=u.searchTextCountInSlice;c.push(u)}let n=[];while(a.length!==0){const d=a[a.length-1];const{position:p,word:g}=d;let e=p-20;let t=p+80;if(e<0){e=0}if(t<p+g.length){t=p+g.length}if(t>r.length){t=r.length}const u=mergeIntoSlice(e,t,a,f);i+=u.searchTextCountInSlice;n.push(u)}n.sort((e,t)=>{if(e.searchTextCount!==t.searchTextCount){return t.searchTextCount-e.searchTextCount}else if(e.hits.length!==t.hits.length){return t.hits.length-e.hits.length}return e.start-t.start});const h=parseInt(theme.navbar.search.top_n_per_article?theme.navbar.search.top_n_per_article:1,10);if(h>=0){n=n.slice(0,h)}let t="";if(c.length!==0){t+=`<li><a href="${s}" class="search-result-title">${highlightKeyword(e,c[0])}</a>`}else{t+=`<li><a href="${s}" class="search-result-title">${e}</a>`}n.forEach(e=>{t+=`<a href="${s}"><p class="search-result">${highlightKeyword(r,e)}...</p></a>`});t+="</li>";w.push({item:t,id:w.length,hitCount:l,searchTextCount:i})}})}if(m.length===1&&m[0]===""){n.innerHTML='<div id="no-result"><i class="fa-solid fa-magnifying-glass fa-5x"></i></div>'}else if(w.length===0){n.innerHTML='<div id="no-result"><i class="fa-solid fa-box-open fa-5x"></i></div>'}else{w.sort((e,t)=>{if(e.searchTextCount!==t.searchTextCount){return t.searchTextCount-e.searchTextCount}else if(e.hitCount!==t.hitCount){return t.hitCount-e.hitCount}return t.id-e.id});let t='<ul class="search-result-list">';w.forEach(e=>{t+=e.item});t+="</ul>";n.innerHTML=t;window.pjax&&window.pjax.refresh(n)}};const handleInput=e=>{if(!e.target.matches(".search-input")){return}renderSearchResult(e.target)};const handleClick=e=>{if(e.target.closest(".search-popup-trigger")){openPopup();return}const t=e.target.closest(".search-pop-overlay");if(t&&e.target===t){closePopup();return}if(e.target.closest(".search-input-field-pre")){const{searchInputDom:n}=getSearchDom();if(n){n.value="";n.focus();renderSearchResult(n)}return}if(e.target.closest(".popup-btn-close")){closePopup()}};const handleKeyup=e=>{if(e.key==="Escape"){closePopup()}};export const initLocalSearchGlobals=({signal:e}={})=>{const t=ensureSearchPath();if(!t){if(!warnedMissing){console.warn("`hexo-generator-searchdb` plugin is not installed!");warnedMissing=true}return}if(didInit){return}didInit=true;if(e){document.addEventListener("input",handleInput,{signal:e});document.addEventListener("click",handleClick,{signal:e});window.addEventListener("keyup",handleKeyup,{signal:e})}else{document.addEventListener("input",handleInput);document.addEventListener("click",handleClick);window.addEventListener("keyup",handleKeyup)}};export const initLocalSearchPage=()=>{const e=ensureSearchPath();if(!e){if(!warnedMissing){console.warn("`hexo-generator-searchdb` plugin is not installed!");warnedMissing=true}return}closePopup();if(theme.navbar?.search?.preload){fetchData()}};