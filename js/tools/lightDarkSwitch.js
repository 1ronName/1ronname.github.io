import{getStyleStatus,styleStatus,updateStyleStatus}from"../state/styleStatus.js";const mermaidSelector=".mermaid";let didInitAuto=false;const ensureOriginalData=()=>{document.querySelectorAll(mermaidSelector).forEach(e=>{if(!e.getAttribute("data-original-code")){e.setAttribute("data-original-code",e.innerHTML)}})};const resetProcessed=()=>{document.querySelectorAll(mermaidSelector).forEach(e=>{const t=e.getAttribute("data-original-code");if(t!==null){e.removeAttribute("data-processed");e.innerHTML=t}})};export const ModeToggle={modeToggleButton_dom:null,iconDom:null,mermaidLightTheme:null,mermaidDarkTheme:null,mermaidInit(e){if(!window.mermaid){return}ensureOriginalData();resetProcessed();mermaid.initialize({theme:e});mermaid.init({theme:e},document.querySelectorAll(mermaidSelector))},enableLightMode(){document.body.classList.remove("dark-mode");document.documentElement.classList.remove("dark");document.body.classList.add("light-mode");document.documentElement.classList.add("light");if(this.iconDom){this.iconDom.className="fa-regular fa-moon"}updateStyleStatus({isDark:false});this.mermaidInit(this.mermaidLightTheme);this.setGiscusTheme();this.setUtterancesTheme()},enableDarkMode(){document.body.classList.remove("light-mode");document.documentElement.classList.remove("light");document.body.classList.add("dark-mode");document.documentElement.classList.add("dark");if(this.iconDom){this.iconDom.className="fa-regular fa-brightness"}updateStyleStatus({isDark:true});this.mermaidInit(this.mermaidDarkTheme);this.setGiscusTheme();this.setUtterancesTheme()},async setGiscusTheme(e){if(!document.querySelector("#giscus-container")){return}let t=document.querySelector("iframe.giscus-frame");while(!t){await new Promise(e=>setTimeout(e,1e3));t=document.querySelector("iframe.giscus-frame")}while(t.classList.contains("giscus-frame--loading")){await new Promise(e=>setTimeout(e,1e3))}e??=styleStatus.isDark?"dark":"light";t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")},async setUtterancesTheme(e){const t=document.querySelector("#utterances-container");if(!t){return}const i=t.dataset.utterancesThemeLight||"github-light";const s=t.dataset.utterancesThemeDark||"github-dark";e??=styleStatus.isDark?s:i;const o=10;let a=document.querySelector("iframe.utterances-frame");for(let e=0;e<o&&!a;e+=1){await new Promise(e=>setTimeout(e,300));a=document.querySelector("iframe.utterances-frame")}if(!a||!a.contentWindow){return}a.contentWindow.postMessage({type:"set-theme",theme:e},"https://utteranc.es")},isDarkPrefersColorScheme(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)")},initModeStatus(){const e=getStyleStatus();if(e){e.isDark?this.enableDarkMode():this.enableLightMode()}else{this.isDarkPrefersColorScheme().matches?this.enableDarkMode():this.enableLightMode()}},initModeToggleButton(e){if(!this.modeToggleButton_dom){return}const t=()=>{const e=document.body.classList.contains("dark-mode");e?this.enableLightMode():this.enableDarkMode()};if(e){this.modeToggleButton_dom.addEventListener("click",t,{signal:e})}else{this.modeToggleButton_dom.addEventListener("click",t)}},initModeAutoTrigger(e){const t=this.isDarkPrefersColorScheme();if(!t||didInitAuto){return}didInitAuto=true;const i=e=>{e.matches?this.enableDarkMode():this.enableLightMode()};if(e){t.addEventListener("change",i,{signal:e})}else{t.addEventListener("change",i)}},init({signal:e,appSignal:t}={}){this.modeToggleButton_dom=document.querySelector(".tool-dark-light-toggle");this.iconDom=document.querySelector(".tool-dark-light-toggle i");const i=theme.plugins?.mermaid?.theme||theme.mermaid?.style||{};this.mermaidLightTheme=i.light||"default";this.mermaidDarkTheme=i.dark||"dark";this.initModeStatus();this.initModeToggleButton(e);this.initModeAutoTrigger(t);ensureOriginalData()}};export default function initModeToggle(e={}){ModeToggle.init(e)}