const viewerState={isBigImage:false,scale:1,fitScale:1,userZoomed:false,isMouseDown:false,dragged:false,currentImgIndex:0,lastMouseX:0,lastMouseY:0,translateX:0,translateY:0,maskDom:null,targetImg:null};const imageSelector=".markdown-body img, .masonry-item img, #shuoshuo-content img";const viewerControls={prevButton:null,nextButton:null,closeButton:null};const exifControls={toggleButton:null,panel:null,cardsContainer:null,closeButton:null,cardTemplate:null,requestId:0};const getI18nValue=e=>{if(!e){return null}const t=String(e).split(".").filter(Boolean);let r=window.i18n;for(const i of t){if(!r||typeof r!=="object"){return null}r=r[i]}return r??null};const t=(e,t="")=>{const r=getI18nValue(e);if(typeof r==="string"){return r}if(r!=null){return String(r)}return t};let imageNodes=[];let didInitKeys=false;const applyTransform=()=>{if(!viewerState.targetImg){return}viewerState.targetImg.style.transform=`translate(${viewerState.translateX}px, ${viewerState.translateY}px) scale(${viewerState.scale})`};const getFrameRect=()=>{if(!viewerState.maskDom){return null}const e=viewerState.maskDom.querySelector(".image-viewer-frame");if(e){return e.getBoundingClientRect()}return viewerState.maskDom.getBoundingClientRect()};const fitToViewport=(e={})=>{if(!viewerState.targetImg){return}const t=getFrameRect();if(!t){return}const r=e.marginFactor??.98;viewerState.scale=1;viewerState.translateX=0;viewerState.translateY=0;applyTransform();const i=viewerState.targetImg.getBoundingClientRect();if(!i.width||!i.height){return}const a=window.innerHeight*r;const n=window.innerWidth;const s=a/i.height;const o=n/i.width;const l=Math.min(1,s,o);viewerState.fitScale=l;viewerState.scale=l;viewerState.translateX=0;viewerState.translateY=0;viewerState.userZoomed=false;applyTransform()};const resetTransform=()=>{fitToViewport()};const showHandle=e=>{if(!viewerState.maskDom){return}document.body.style.overflow=e?"hidden":"auto";viewerState.maskDom.classList.toggle("active",e)};const closeViewer=()=>{if(!viewerState.isBigImage){return}viewerState.isBigImage=false;showHandle(false);resetTransform();viewerState.userZoomed=false;resetExifUI()};const updateImageNodes=()=>{imageNodes=Array.from(document.querySelectorAll(imageSelector))};const canGoPrev=()=>viewerState.currentImgIndex>0;const canGoNext=()=>viewerState.currentImgIndex<Math.max(imageNodes.length-1,0);const updateNavButtons=()=>{if(!viewerControls.prevButton||!viewerControls.nextButton){return}viewerControls.prevButton.classList.toggle("is-disabled",!canGoPrev());viewerControls.nextButton.classList.toggle("is-disabled",!canGoNext())};const hasExifFlag=e=>e?.dataset?.exif==="true";const resolveExifImageUrl=e=>{if(!e){return null}const t=e.getAttribute("data-src");const r=t||e.currentSrc||e.src;if(!r){return null}try{return new URL(r,window.location.href).toString()}catch(e){return r}};const formatExifValue=e=>{if(!e){return null}if(typeof e==="object"){if(e.description!=null){return String(e.description).trim()}if(e.value!=null){if(Array.isArray(e.value)){return e.value.map(e=>String(e)).join(", ").trim()}return String(e.value).trim()}}if(typeof e==="string"){return e.trim()}return String(e).trim()};const getExifValueByKeys=(e,t=[])=>{if(!e||!Array.isArray(t)){return null}for(const r of t){const i=formatExifValue(e[r]);if(i){return i}}return null};const parseRational=e=>{if(typeof e==="number"){return Number.isFinite(e)?e:null}if(e&&typeof e==="object"){const t=e.numerator??e.num;const r=e.denominator??e.den;if(Number.isFinite(t)&&Number.isFinite(r)&&r!==0){return t/r}if(Number.isFinite(e.value)){return e.value}}if(typeof e==="string"){const i=Number.parseFloat(e);return Number.isFinite(i)?i:null}return null};const resolveTagRawValue=e=>{if(!e){return null}if(typeof e==="object"&&"value"in e){return e.value}return e};const formatGpsCoordinate=(e,t,r)=>{if(!e){return null}const i=e[t];if(!i){return null}const a=resolveTagRawValue(i);const n=formatExifValue(e[r]);let s=null;if(Array.isArray(a)){const u=a.map(parseRational).filter(e=>e!=null);if(u.length>=3){const[c,f,d]=u;s=c+f/60+d/3600}}else{s=parseRational(a)}if(s==null){const g=formatExifValue(i);if(!g){return null}if(n&&!g.includes(n)){return`${g} ${n}`}return g}const o=n?String(n).trim().toUpperCase():"";const l=Math.abs(s).toFixed(4);if(o){return`${l} ${o}`}return s.toFixed(4)};const buildExifGroups=e=>{if(!e){return[]}const a=[];const r=(e,t,r)=>{const i=(r||[]).filter(Boolean);if(i.length===0){return}a.push({title:e,icon:t,items:i})};const i=getExifValueByKeys(e,["Make"]);const n=getExifValueByKeys(e,["Model"]);const s=getExifValueByKeys(e,["DateTimeOriginal","DateTime"]);r(t("exif.cards.camera","Camera"),"fa-solid fa-camera",[i&&{label:t("exif.fields.make","Brand"),value:i},n&&{label:t("exif.fields.model","Model"),value:n},s&&{label:t("exif.fields.date_taken","Date taken"),value:s}]);const o=getExifValueByKeys(e,["LensModel","Lens","LensSpecification"]);const l=getExifValueByKeys(e,["FocalLength","FocalLengthIn35mmFilm"]);const u=getExifValueByKeys(e,["FocusMode","AFMode","AFAreaMode","FocusingMode","AutoFocus","FocusMethod"]);r(t("exif.cards.lens","Lens"),"fa-solid fa-eye",[o&&{label:t("exif.fields.lens_model","Lens"),value:o},l&&{label:t("exif.fields.focal_length","Focal length"),value:l},u&&{label:t("exif.fields.focus_mode","Focus mode"),value:u}]);const c=getExifValueByKeys(e,["ExposureTime"]);const f=getExifValueByKeys(e,["FNumber"]);const d=getExifValueByKeys(e,["ISO","PhotographicSensitivity"]);const g=getExifValueByKeys(e,["ExposureProgram"]);const m=getExifValueByKeys(e,["ExposureBiasValue"]);const v=getExifValueByKeys(e,["MeteringMode"]);r(t("exif.cards.exposure","Exposure"),"fa-solid fa-sun",[c&&{label:t("exif.fields.shutter","Shutter"),value:c},f&&{label:t("exif.fields.aperture","Aperture"),value:f},d&&{label:t("exif.fields.iso","ISO"),value:d},g&&{label:t("exif.fields.exposure_program","Exposure program"),value:g},m&&{label:t("exif.fields.exposure_compensation","Exposure compensation"),value:m},v&&{label:t("exif.fields.metering_mode","Metering mode"),value:v}]);const x=getExifValueByKeys(e,["Flash"]);const w=getExifValueByKeys(e,["WhiteBalance"]);const p=formatGpsCoordinate(e,"GPSLatitude","GPSLatitudeRef");const S=formatGpsCoordinate(e,"GPSLongitude","GPSLongitudeRef");const E=getExifValueByKeys(e,["GPSAltitude"]);r(t("exif.cards.other","Other"),"fa-solid fa-gear",[x&&{label:t("exif.fields.flash","Flash"),value:x},w&&{label:t("exif.fields.white_balance","White balance"),value:w},p&&{label:t("exif.fields.latitude","Latitude"),value:p},S&&{label:t("exif.fields.longitude","Longitude"),value:S},E&&{label:t("exif.fields.altitude","Altitude"),value:E}]);return a};const setExifPanelOpen=e=>{if(!exifControls.panel||!exifControls.toggleButton){return}exifControls.panel.classList.toggle("hidden",!e);exifControls.panel.setAttribute("aria-hidden",e?"false":"true");exifControls.toggleButton.setAttribute("aria-expanded",e?"true":"false")};const clearExifCards=()=>{if(!exifControls.cardsContainer){return}exifControls.cardsContainer.innerHTML=""};const createExifItem=(e,t)=>{const r=document.createElement("div");r.className="image-viewer-exif-item flex items-start justify-between gap-2";const i=document.createElement("div");i.className="image-viewer-exif-item-label text-[0.65rem] uppercase tracking-wide shrink-0 text-third-text-color";i.textContent=e;const a=document.createElement("div");a.className="image-viewer-exif-item-value text-[0.65rem] text-first-text-color text-right";a.textContent=t;r.appendChild(i);r.appendChild(a);return r};const createExifCard=e=>{const t=exifControls.cardTemplate;const r=t?.content?.firstElementChild;let i=r?r.cloneNode(true):null;if(!i){i=document.createElement("div");i.className="rounded-lg border border-border-color bg-background-color-transparent-80 px-3 py-2 shadow-redefine-flat";const o=document.createElement("div");o.className="image-viewer-exif-card-header flex items-center gap-2 mb-1";const n=document.createElement("i");n.className="image-viewer-exif-card-icon fa-solid fa-circle-info text-xs text-third-text-color";const a=document.createElement("div");a.className="image-viewer-exif-card-title text-xs font-semibold text-first-text-color";o.appendChild(n);o.appendChild(a);const s=document.createElement("div");s.className="image-viewer-exif-card-items flex flex-col gap-1";i.appendChild(o);i.appendChild(s)}const a=i.querySelector(".image-viewer-exif-card-title");const n=i.querySelector(".image-viewer-exif-card-icon");let s=i.querySelector(".image-viewer-exif-card-items");if(!s){s=document.createElement("div");s.className="image-viewer-exif-card-items flex flex-col gap-1";i.appendChild(s)}if(a){a.textContent=e.title}if(n){const l=e.icon||"fa-solid fa-circle-info";n.className=`image-viewer-exif-card-icon ${l} text-xs text-third-text-color`}s.innerHTML="";e.items.forEach(e=>{s.appendChild(createExifItem(e.label,e.value))});return i};const renderExifGroups=e=>{if(!exifControls.cardsContainer){return}clearExifCards();const r=Array.isArray(e)?e.map(e=>{if(!e||typeof e!=="object"){return null}const t=String(e.title||"").trim();const r=String(e.icon||"").trim();const i=Array.isArray(e.items)?e.items.map(e=>{if(!e||typeof e!=="object"){return null}const t=String(e.label||"").trim();const r=String(e.value??"").trim();if(!t||!r){return null}return{label:t,value:r}}).filter(Boolean):[];if(!t||i.length===0){return null}return{title:t,icon:r,items:i}}).filter(Boolean):[];const i=t("exif.title","EXIF");const a=r.length?r:[{title:i,icon:"fa-solid fa-circle-info",items:[{label:i,value:t("exif.status.no_exif","No EXIF available")}]}];const n=document.createDocumentFragment();a.forEach(e=>{n.appendChild(createExifCard(e))});exifControls.cardsContainer.appendChild(n)};const bumpExifRequestId=()=>{exifControls.requestId=(exifControls.requestId||0)+1;return exifControls.requestId};const renderExifMessage=e=>{const r=t("exif.title","EXIF");renderExifGroups([{title:r,icon:"fa-solid fa-circle-info",items:[{label:r,value:e}]}])};const loadExifForImage=async e=>{const r=bumpExifRequestId();renderExifMessage(t("exif.status.loading","Loading..."));const i=window.ExifReader;if(!i||typeof i.load!=="function"){if(exifControls.requestId!==r){return}renderExifMessage(t("exif.status.library_missing","EXIF library not loaded"));return}const a=resolveExifImageUrl(e);if(!a){if(exifControls.requestId!==r){return}renderExifMessage(t("exif.status.image_source_missing","Image source unavailable"));return}try{const n=await i.load(a);if(exifControls.requestId!==r){return}const s=buildExifGroups(n);if(s.length===0){renderExifMessage(t("exif.status.no_exif","No EXIF available"));return}renderExifGroups(s)}catch(e){if(exifControls.requestId!==r){return}renderExifMessage(t("exif.status.unavailable","EXIF unavailable (blocked by CORS or missing metadata)"))}};const updateExifUI=e=>{const t=hasExifFlag(e);bumpExifRequestId();if(exifControls.toggleButton){exifControls.toggleButton.classList.toggle("hidden",!t);exifControls.toggleButton.disabled=!t}setExifPanelOpen(false);clearExifCards()};const resetExifUI=()=>{bumpExifRequestId();if(exifControls.toggleButton){exifControls.toggleButton.classList.add("hidden");exifControls.toggleButton.setAttribute("aria-expanded","false")}setExifPanelOpen(false);clearExifCards()};const updateViewerImage=e=>{const t=imageNodes[e];if(!t||!viewerState.targetImg){return}viewerState.currentImgIndex=e;let r=t.src;if(t.hasAttribute("lazyload")){r=t.getAttribute("data-src")||r;if(r){t.src=r}t.removeAttribute("lazyload")}if(r){viewerState.targetImg.src=r}viewerState.targetImg.alt=t.alt||"";const i=()=>{viewerState.targetImg?.removeEventListener("load",i);fitToViewport()};if(viewerState.targetImg.complete){fitToViewport()}else{viewerState.targetImg.addEventListener("load",i,{once:true})}updateNavButtons();updateExifUI(t)};const goPrev=()=>{if(!viewerState.isBigImage||!canGoPrev()){return}updateViewerImage(viewerState.currentImgIndex-1)};const goNext=()=>{if(!viewerState.isBigImage||!canGoNext()){return}updateViewerImage(viewerState.currentImgIndex+1)};const handleArrowKeys=e=>{if(!viewerState.isBigImage){return}if(e.key==="Escape"){e.preventDefault();closeViewer();return}if(e.key==="ArrowUp"||e.key==="ArrowLeft"){e.preventDefault();goPrev();return}if(e.key==="ArrowDown"||e.key==="ArrowRight"){e.preventDefault();goNext()}};const registerGlobalHandlers=e=>{if(didInitKeys){return}didInitKeys=true;if(e){document.addEventListener("keydown",handleArrowKeys,{signal:e})}else{document.addEventListener("keydown",handleArrowKeys)}};export default function initImageViewer({signal:e,appSignal:r}={}){const i=document.querySelector(".image-viewer-container");if(!i){console.warn("Image viewer container not found. Exiting imageViewer function.");return}const a=i.querySelector("img");if(!a){console.warn("Target image not found in image viewer container. Exiting imageViewer function.");return}viewerState.maskDom=i;viewerState.targetImg=a;viewerState.dragged=false;viewerControls.prevButton=i.querySelector(".image-viewer-prev");viewerControls.nextButton=i.querySelector(".image-viewer-next");viewerControls.closeButton=i.querySelector(".image-viewer-close");exifControls.toggleButton=i.querySelector(".image-viewer-exif-toggle");exifControls.panel=i.querySelector(".image-viewer-exif-panel");exifControls.cardsContainer=i.querySelector(".image-viewer-exif-cards");exifControls.closeButton=i.querySelector(".image-viewer-exif-close");exifControls.cardTemplate=i.querySelector(".image-viewer-exif-card-template");updateImageNodes();registerGlobalHandlers(r);updateNavButtons();resetExifUI();const n=e=>{if(!e.ctrlKey){return}e.preventDefault();if(!viewerState.targetImg){return}const t=viewerState.targetImg.getBoundingClientRect();const r=e.clientX-t.left;const i=e.clientY-t.top;const a=r-t.width/2;const n=i-t.height/2;const s=viewerState.scale;const o=Math.max(.2,viewerState.fitScale*.8);const l=Math.min(8,viewerState.fitScale*4);viewerState.scale+=e.deltaY*-.001;viewerState.scale=Math.min(Math.max(o,viewerState.scale),l);viewerState.userZoomed=Math.abs(viewerState.scale-viewerState.fitScale)>.01;if(s<viewerState.scale){viewerState.translateX-=a*(viewerState.scale-s);viewerState.translateY-=n*(viewerState.scale-s)}else{viewerState.translateX=0;viewerState.translateY=0}applyTransform()};const s=e=>{if(viewerState.scale<=viewerState.fitScale+.01){return}e.preventDefault();viewerState.isMouseDown=true;viewerState.lastMouseX=e.clientX;viewerState.lastMouseY=e.clientY;l=e.clientX;u=e.clientY;viewerState.targetImg.style.cursor="grabbing";viewerState.userZoomed=true};let o=null;let l=null;let u=null;const c=e=>{if(!viewerState.isMouseDown){return}if(viewerState.scale<=viewerState.fitScale+.01){return}l=e.clientX;u=e.clientY;if(o!==null){return}o=window.requestAnimationFrame(()=>{if(l==null||u==null){o=null;return}const e=l-viewerState.lastMouseX;const t=u-viewerState.lastMouseY;viewerState.translateX+=e;viewerState.translateY+=t;viewerState.lastMouseX=l;viewerState.lastMouseY=u;applyTransform();viewerState.dragged=true;o=null})};const f=e=>{if(viewerState.isMouseDown){e.stopPropagation()}viewerState.isMouseDown=false;if(o!==null){window.cancelAnimationFrame(o);o=null}l=null;u=null;if(viewerState.dragged){window.setTimeout(()=>{viewerState.dragged=false},0)}viewerState.targetImg.style.cursor="grab"};const d=e=>{const t=e.target.closest(imageSelector);if(!t||t.closest(".image-viewer-container")){return}updateImageNodes();const r=imageNodes.indexOf(t);viewerState.isBigImage=true;viewerState.dragged=false;viewerState.userZoomed=false;showHandle(true);updateViewerImage(r===-1?0:r)};const g=e=>{if(viewerState.dragged){return}const t=e.target;if(t.closest(".image-viewer-prev, .image-viewer-next, .image-viewer-close, .image-viewer-exif-panel, .image-viewer-exif-toggle")){return}if(t.closest(".image-viewer-frame img")){return}const r=i.querySelector(".image-viewer-frame");if(t===i||r&&t===r){closeViewer()}};const m=e=>{e.stopPropagation();goPrev()};const v=e=>{e.stopPropagation();goNext()};const x=e=>{e.stopPropagation();closeViewer()};const w=e=>{e.stopPropagation();if(!exifControls.panel){return}const r=!exifControls.panel.classList.contains("hidden");if(r){setExifPanelOpen(false);return}setExifPanelOpen(true);const i=imageNodes[viewerState.currentImgIndex];if(!hasExifFlag(i)){renderExifMessage(t("exif.status.flag_unavailable","EXIF unavailable"));return}loadExifForImage(i)};const p=e=>{e.stopPropagation();setExifPanelOpen(false)};const S=()=>{if(!viewerState.isBigImage||viewerState.userZoomed){return}fitToViewport()};if(e){a.addEventListener("wheel",n,{passive:false,signal:e});a.addEventListener("mousedown",s,{passive:false,signal:e});a.addEventListener("mousemove",c,{passive:false,signal:e});a.addEventListener("mouseup",f,{passive:false,signal:e});a.addEventListener("mouseleave",f,{passive:false,signal:e});i.addEventListener("click",g,{signal:e});window.addEventListener("resize",S,{signal:e});document.addEventListener("click",d,{signal:e});viewerControls.prevButton?.addEventListener("click",m,{signal:e});viewerControls.nextButton?.addEventListener("click",v,{signal:e});viewerControls.closeButton?.addEventListener("click",x,{signal:e});exifControls.toggleButton?.addEventListener("click",w,{signal:e});exifControls.closeButton?.addEventListener("click",p,{signal:e})}else{a.addEventListener("wheel",n,{passive:false});a.addEventListener("mousedown",s,{passive:false});a.addEventListener("mousemove",c,{passive:false});a.addEventListener("mouseup",f,{passive:false});a.addEventListener("mouseleave",f,{passive:false});i.addEventListener("click",g);window.addEventListener("resize",S);document.addEventListener("click",d);viewerControls.prevButton?.addEventListener("click",m);viewerControls.nextButton?.addEventListener("click",v);viewerControls.closeButton?.addEventListener("click",x);exifControls.toggleButton?.addEventListener("click",w);exifControls.closeButton?.addEventListener("click",p)}}