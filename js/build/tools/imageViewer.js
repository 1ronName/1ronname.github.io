const e={isBigImage:!1,scale:1,fitScale:1,userZoomed:!1,isMouseDown:!1,dragged:!1,currentImgIndex:0,lastMouseX:0,lastMouseY:0,translateX:0,translateY:0,maskDom:null,targetImg:null},i=".markdown-body img, .masonry-item img, #shuoshuo-content img",n={prevButton:null,nextButton:null,closeButton:null},a={toggleButton:null,panel:null,cardsContainer:null,closeButton:null,cardTemplate:null,requestId:0},t=(e,t="")=>{const a=(e=>{if(!e)return null;const t=String(e).split(".").filter(Boolean);let a=window.i18n;for(const e of t){if(!a||"object"!=typeof a)return null;a=a[e]}return a??null})(e);return"string"==typeof a?a:null!=a?String(a):t};let r=[],l=!1;const applyTransform=()=>{e.targetImg&&(e.targetImg.style.transform=`translate(${e.translateX}px, ${e.translateY}px) scale(${e.scale})`)},fitToViewport=(t={})=>{if(!e.targetImg)return;if(!(()=>{if(!e.maskDom)return null;const t=e.maskDom.querySelector(".image-viewer-frame");return t?t.getBoundingClientRect():e.maskDom.getBoundingClientRect()})())return;const a=t.marginFactor??.98;e.scale=1,e.translateX=0,e.translateY=0,applyTransform();const i=e.targetImg.getBoundingClientRect();if(!i.width||!i.height)return;const n=window.innerHeight*a,r=window.innerWidth,l=n/i.height,s=r/i.width,o=Math.min(1,l,s);e.fitScale=o,e.scale=o,e.translateX=0,e.translateY=0,e.userZoomed=!1,applyTransform()},showHandle=t=>{e.maskDom&&(document.body.style.overflow=t?"hidden":"auto",e.maskDom.classList.toggle("active",t))},closeViewer=()=>{e.isBigImage&&(e.isBigImage=!1,showHandle(!1),fitToViewport(),e.userZoomed=!1,resetExifUI())},updateImageNodes=()=>{r=Array.from(document.querySelectorAll(i))},canGoPrev=()=>e.currentImgIndex>0,canGoNext=()=>e.currentImgIndex<Math.max(r.length-1,0),updateNavButtons=()=>{n.prevButton&&n.nextButton&&(n.prevButton.classList.toggle("is-disabled",!canGoPrev()),n.nextButton.classList.toggle("is-disabled",!canGoNext()))},hasExifFlag=e=>"true"===e?.dataset?.exif,formatExifValue=e=>{if(!e)return null;if("object"==typeof e){if(null!=e.description)return String(e.description).trim();if(null!=e.value)return Array.isArray(e.value)?e.value.map(e=>String(e)).join(", ").trim():String(e.value).trim()}return"string"==typeof e?e.trim():String(e).trim()},getExifValueByKeys=(t,a=[])=>{if(!t||!Array.isArray(a))return null;for(const e of a){const a=formatExifValue(t[e]);if(a)return a}return null},parseRational=a=>{if("number"==typeof a)return Number.isFinite(a)?a:null;if(a&&"object"==typeof a){const e=a.numerator??a.num,t=a.denominator??a.den;if(Number.isFinite(e)&&Number.isFinite(t)&&0!==t)return e/t;if(Number.isFinite(a.value))return a.value}if("string"==typeof a){const e=Number.parseFloat(a);return Number.isFinite(e)?e:null}return null},formatGpsCoordinate=(e,t,a)=>{if(!e)return null;const i=e[t];if(!i)return null;const n=(r=i)?"object"==typeof r&&"value"in r?r.value:r:null;var r;const l=formatExifValue(e[a]);let s=null;if(Array.isArray(n)){const e=n.map(parseRational).filter(e=>null!=e);if(e.length>=3){const[t,a,i]=e;s=t+a/60+i/3600}}else s=parseRational(n);if(null==s){const e=formatExifValue(i);return e?l&&!e.includes(l)?`${e} ${l}`:e:null}const o=l?String(l).trim().toUpperCase():"",u=Math.abs(s).toFixed(4);return o?`${u} ${o}`:s.toFixed(4)},setExifPanelOpen=e=>{a.panel&&a.toggleButton&&(a.panel.classList.toggle("hidden",!e),a.panel.setAttribute("aria-hidden",e?"false":"true"),a.toggleButton.setAttribute("aria-expanded",e?"true":"false"))},clearExifCards=()=>{a.cardsContainer&&(a.cardsContainer.innerHTML="")},createExifCard=e=>{const t=a.cardTemplate,i=t?.content?.firstElementChild;let n=i?i.cloneNode(!0):null;if(!n){n=document.createElement("div"),n.className="rounded-lg border border-border-color bg-background-color-transparent-80 px-3 py-2 shadow-redefine-flat";const e=document.createElement("div");e.className="image-viewer-exif-card-header flex items-center gap-2 mb-1";const t=document.createElement("i");t.className="image-viewer-exif-card-icon fa-solid fa-circle-info text-xs text-third-text-color";const i=document.createElement("div");i.className="image-viewer-exif-card-title text-xs font-semibold text-first-text-color",e.appendChild(t),e.appendChild(i);const a=document.createElement("div");a.className="image-viewer-exif-card-items flex flex-col gap-1",n.appendChild(e),n.appendChild(a)}const r=n.querySelector(".image-viewer-exif-card-title"),l=n.querySelector(".image-viewer-exif-card-icon");let s=n.querySelector(".image-viewer-exif-card-items");if(s||(s=document.createElement("div"),s.className="image-viewer-exif-card-items flex flex-col gap-1",n.appendChild(s)),r&&(r.textContent=e.title),l){const t=e.icon||"fa-solid fa-circle-info";l.className=`image-viewer-exif-card-icon ${t} text-xs text-third-text-color`}return s.innerHTML="",e.items.forEach(e=>{s.appendChild(((e,t)=>{const a=document.createElement("div");a.className="image-viewer-exif-item flex items-start justify-between gap-2";const i=document.createElement("div");i.className="image-viewer-exif-item-label text-[0.65rem] uppercase tracking-wide shrink-0 text-third-text-color",i.textContent=e;const n=document.createElement("div");return n.className="image-viewer-exif-item-value text-[0.65rem] text-first-text-color text-right",n.textContent=t,a.appendChild(i),a.appendChild(n),a})(e.label,e.value))}),n},renderExifGroups=e=>{if(!a.cardsContainer)return;clearExifCards();const i=Array.isArray(e)?e.map(e=>{if(!e||"object"!=typeof e)return null;const t=String(e.title||"").trim(),a=String(e.icon||"").trim(),i=Array.isArray(e.items)?e.items.map(e=>{if(!e||"object"!=typeof e)return null;const t=String(e.label||"").trim(),a=String(e.value??"").trim();return t&&a?{label:t,value:a}:null}).filter(Boolean):[];return t&&0!==i.length?{title:t,icon:a,items:i}:null}).filter(Boolean):[],n=t("exif.title","EXIF"),r=i.length?i:[{title:n,icon:"fa-solid fa-circle-info",items:[{label:n,value:t("exif.status.no_exif","No EXIF available")}]}],l=document.createDocumentFragment();r.forEach(e=>{l.appendChild(createExifCard(e))}),a.cardsContainer.appendChild(l)},bumpExifRequestId=()=>(a.requestId=(a.requestId||0)+1,a.requestId),renderExifMessage=e=>{const a=t("exif.title","EXIF");renderExifGroups([{title:a,icon:"fa-solid fa-circle-info",items:[{label:a,value:e}]}])},loadExifForImage=async i=>{const n=bumpExifRequestId();renderExifMessage(t("exif.status.loading","Loading..."));const r=window.ExifReader;if(!r||"function"!=typeof r.load){if(a.requestId!==n)return;return void renderExifMessage(t("exif.status.library_missing","EXIF library not loaded"))}const l=(e=>{if(!e)return null;const t=e.getAttribute("data-src")||e.currentSrc||e.src;if(!t)return null;try{return new URL(t,window.location.href).toString()}catch(e){return t}})(i);if(l)try{const i=await r.load(l);if(a.requestId!==n)return;const e=(e=>{if(!e)return[];const n=[],a=(e,t,a)=>{const i=(a||[]).filter(Boolean);0!==i.length&&n.push({title:e,icon:t,items:i})},i=getExifValueByKeys(e,["Make"]),r=getExifValueByKeys(e,["Model"]),l=getExifValueByKeys(e,["DateTimeOriginal","DateTime"]);a(t("exif.cards.camera","Camera"),"fa-solid fa-camera",[i&&{label:t("exif.fields.make","Brand"),value:i},r&&{label:t("exif.fields.model","Model"),value:r},l&&{label:t("exif.fields.date_taken","Date taken"),value:l}]);const s=getExifValueByKeys(e,["LensModel","Lens","LensSpecification"]),o=getExifValueByKeys(e,["FocalLength","FocalLengthIn35mmFilm"]),u=getExifValueByKeys(e,["FocusMode","AFMode","AFAreaMode","FocusingMode","AutoFocus","FocusMethod"]);a(t("exif.cards.lens","Lens"),"fa-solid fa-eye",[s&&{label:t("exif.fields.lens_model","Lens"),value:s},o&&{label:t("exif.fields.focal_length","Focal length"),value:o},u&&{label:t("exif.fields.focus_mode","Focus mode"),value:u}]);const d=getExifValueByKeys(e,["ExposureTime"]),c=getExifValueByKeys(e,["FNumber"]),g=getExifValueByKeys(e,["ISO","PhotographicSensitivity"]),f=getExifValueByKeys(e,["ExposureProgram"]),m=getExifValueByKeys(e,["ExposureBiasValue"]),x=getExifValueByKeys(e,["MeteringMode"]);a(t("exif.cards.exposure","Exposure"),"fa-solid fa-sun",[d&&{label:t("exif.fields.shutter","Shutter"),value:d},c&&{label:t("exif.fields.aperture","Aperture"),value:c},g&&{label:t("exif.fields.iso","ISO"),value:g},f&&{label:t("exif.fields.exposure_program","Exposure program"),value:f},m&&{label:t("exif.fields.exposure_compensation","Exposure compensation"),value:m},x&&{label:t("exif.fields.metering_mode","Metering mode"),value:x}]);const p=getExifValueByKeys(e,["Flash"]),v=getExifValueByKeys(e,["WhiteBalance"]),E=formatGpsCoordinate(e,"GPSLatitude","GPSLatitudeRef"),y=formatGpsCoordinate(e,"GPSLongitude","GPSLongitudeRef"),w=getExifValueByKeys(e,["GPSAltitude"]);return a(t("exif.cards.other","Other"),"fa-solid fa-gear",[p&&{label:t("exif.fields.flash","Flash"),value:p},v&&{label:t("exif.fields.white_balance","White balance"),value:v},E&&{label:t("exif.fields.latitude","Latitude"),value:E},y&&{label:t("exif.fields.longitude","Longitude"),value:y},w&&{label:t("exif.fields.altitude","Altitude"),value:w}]),n})(i);if(0===e.length)return void renderExifMessage(t("exif.status.no_exif","No EXIF available"));renderExifGroups(e)}catch(i){if(a.requestId!==n)return;renderExifMessage(t("exif.status.unavailable","EXIF unavailable (blocked by CORS or missing metadata)"))}else{if(a.requestId!==n)return;renderExifMessage(t("exif.status.image_source_missing","Image source unavailable"))}},resetExifUI=()=>{bumpExifRequestId(),a.toggleButton&&(a.toggleButton.classList.add("hidden"),a.toggleButton.setAttribute("aria-expanded","false")),setExifPanelOpen(!1),clearExifCards()},updateViewerImage=t=>{const i=r[t];if(!i||!e.targetImg)return;e.currentImgIndex=t;let n=i.src;i.hasAttribute("lazyload")&&(n=i.getAttribute("data-src")||n,n&&(i.src=n),i.removeAttribute("lazyload")),n&&(e.targetImg.src=n),e.targetImg.alt=i.alt||"";const l=()=>{e.targetImg?.removeEventListener("load",l),fitToViewport()};e.targetImg.complete?fitToViewport():e.targetImg.addEventListener("load",l,{once:!0}),updateNavButtons(),(e=>{const t=hasExifFlag(e);bumpExifRequestId(),a.toggleButton&&(a.toggleButton.classList.toggle("hidden",!t),a.toggleButton.disabled=!t),setExifPanelOpen(!1),clearExifCards()})(i)},goPrev=()=>{e.isBigImage&&canGoPrev()&&updateViewerImage(e.currentImgIndex-1)},goNext=()=>{e.isBigImage&&canGoNext()&&updateViewerImage(e.currentImgIndex+1)},handleArrowKeys=t=>{if(e.isBigImage)return"Escape"===t.key?(t.preventDefault(),void closeViewer()):"ArrowUp"===t.key||"ArrowLeft"===t.key?(t.preventDefault(),void goPrev()):void("ArrowDown"!==t.key&&"ArrowRight"!==t.key||(t.preventDefault(),goNext()))};export default function initImageViewer({signal:s,appSignal:o}={}){const u=document.querySelector(".image-viewer-container");if(!u)return void console.warn("Image viewer container not found. Exiting imageViewer function.");const d=u.querySelector("img");if(!d)return void console.warn("Target image not found in image viewer container. Exiting imageViewer function.");e.maskDom=u,e.targetImg=d,e.dragged=!1,n.prevButton=u.querySelector(".image-viewer-prev"),n.nextButton=u.querySelector(".image-viewer-next"),n.closeButton=u.querySelector(".image-viewer-close"),a.toggleButton=u.querySelector(".image-viewer-exif-toggle"),a.panel=u.querySelector(".image-viewer-exif-panel"),a.cardsContainer=u.querySelector(".image-viewer-exif-cards"),a.closeButton=u.querySelector(".image-viewer-exif-close"),a.cardTemplate=u.querySelector(".image-viewer-exif-card-template"),updateImageNodes(),(e=>{l||(l=!0,e?document.addEventListener("keydown",handleArrowKeys,{signal:e}):document.addEventListener("keydown",handleArrowKeys))})(o),updateNavButtons(),resetExifUI();const c=t=>{if(!t.ctrlKey)return;if(t.preventDefault(),!e.targetImg)return;const a=e.targetImg.getBoundingClientRect(),i=t.clientX-a.left,n=t.clientY-a.top,r=i-a.width/2,l=n-a.height/2,s=e.scale,o=Math.max(.2,.8*e.fitScale),u=Math.min(8,4*e.fitScale);e.scale+=-.001*t.deltaY,e.scale=Math.min(Math.max(o,e.scale),u),e.userZoomed=Math.abs(e.scale-e.fitScale)>.01,s<e.scale?(e.translateX-=r*(e.scale-s),e.translateY-=l*(e.scale-s)):(e.translateX=0,e.translateY=0),applyTransform()},g=t=>{e.scale<=e.fitScale+.01||(t.preventDefault(),e.isMouseDown=!0,e.lastMouseX=t.clientX,e.lastMouseY=t.clientY,m=t.clientX,x=t.clientY,e.targetImg.style.cursor="grabbing",e.userZoomed=!0)};let f=null,m=null,x=null;const p=t=>{e.isMouseDown&&(e.scale<=e.fitScale+.01||(m=t.clientX,x=t.clientY,null===f&&(f=window.requestAnimationFrame(()=>{if(null==m||null==x)return void(f=null);const t=m-e.lastMouseX,a=x-e.lastMouseY;e.translateX+=t,e.translateY+=a,e.lastMouseX=m,e.lastMouseY=x,applyTransform(),e.dragged=!0,f=null}))))},v=t=>{e.isMouseDown&&t.stopPropagation(),e.isMouseDown=!1,null!==f&&(window.cancelAnimationFrame(f),f=null),m=null,x=null,e.dragged&&window.setTimeout(()=>{e.dragged=!1},0),e.targetImg.style.cursor="grab"},E=t=>{const a=t.target.closest(i);if(!a||a.closest(".image-viewer-container"))return;updateImageNodes();const n=r.indexOf(a);e.isBigImage=!0,e.dragged=!1,e.userZoomed=!1,showHandle(!0),updateViewerImage(-1===n?0:n)},y=t=>{if(e.dragged)return;const a=t.target;if(a.closest(".image-viewer-prev, .image-viewer-next, .image-viewer-close, .image-viewer-exif-panel, .image-viewer-exif-toggle"))return;if(a.closest(".image-viewer-frame img"))return;const i=u.querySelector(".image-viewer-frame");(a===u||i&&a===i)&&closeViewer()},w=e=>{e.stopPropagation(),goPrev()},h=e=>{e.stopPropagation(),goNext()},b=e=>{e.stopPropagation(),closeViewer()},I=i=>{if(i.stopPropagation(),!a.panel)return;if(!a.panel.classList.contains("hidden"))return void setExifPanelOpen(!1);setExifPanelOpen(!0);const n=r[e.currentImgIndex];hasExifFlag(n)?loadExifForImage(n):renderExifMessage(t("exif.status.flag_unavailable","EXIF unavailable"))},B=e=>{e.stopPropagation(),setExifPanelOpen(!1)},L=()=>{e.isBigImage&&!e.userZoomed&&fitToViewport()};s?(d.addEventListener("wheel",c,{passive:!1,signal:s}),d.addEventListener("mousedown",g,{passive:!1,signal:s}),d.addEventListener("mousemove",p,{passive:!1,signal:s}),d.addEventListener("mouseup",v,{passive:!1,signal:s}),d.addEventListener("mouseleave",v,{passive:!1,signal:s}),u.addEventListener("click",y,{signal:s}),window.addEventListener("resize",L,{signal:s}),document.addEventListener("click",E,{signal:s}),n.prevButton?.addEventListener("click",w,{signal:s}),n.nextButton?.addEventListener("click",h,{signal:s}),n.closeButton?.addEventListener("click",b,{signal:s}),a.toggleButton?.addEventListener("click",I,{signal:s}),a.closeButton?.addEventListener("click",B,{signal:s})):(d.addEventListener("wheel",c,{passive:!1}),d.addEventListener("mousedown",g,{passive:!1}),d.addEventListener("mousemove",p,{passive:!1}),d.addEventListener("mouseup",v,{passive:!1}),d.addEventListener("mouseleave",v,{passive:!1}),u.addEventListener("click",y),window.addEventListener("resize",L),document.addEventListener("click",E),n.prevButton?.addEventListener("click",w),n.nextButton?.addEventListener("click",h),n.closeButton?.addEventListener("click",b),a.toggleButton?.addEventListener("click",I),a.closeButton?.addEventListener("click",B))}