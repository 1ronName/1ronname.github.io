let t=!1,e=[],n=null,o=!0,s=!1,r=!1;const ensureSearchPath=()=>n||(()=>{const e=config.path;if(!e)return null;let t=e;return o=!0,0===t.length?t="search.xml":t.endsWith("json")&&(o=!1),n=t,t})(),fetchData=()=>{!t&&n&&fetch(config.root+n).then(e=>e.text()).then(n=>{t=!0,e=o?[...(new DOMParser).parseFromString(n,"text/xml").querySelectorAll("entry")].map(e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent})):JSON.parse(n),e=e.filter(e=>e.title).map(e=>(e.title=e.title.trim(),e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"",e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/"),e));const r=document.querySelector("#no-result");r&&(r.innerHTML='<i class="fa-solid fa-magnifying-glass fa-5x"></i>')}).catch(e=>{console.error("Failed to load search data:",e)})},getSearchDom=()=>({searchInputDom:document.querySelector(".search-input"),resultContent:document.getElementById("search-result"),overlay:document.querySelector(".search-pop-overlay")}),closePopup=()=>{const{overlay:e}=getSearchDom();e&&(document.body.style.overflow="",e.classList.remove("active"))},getIndexByWord=(e,t,n)=>{const o=e.length;if(0===o)return[];let r=0,s=[];const l=[];for(n||(t=t.toLowerCase(),e=e.toLowerCase());(s=t.indexOf(e,r))>-1;)l.push({position:s,word:e}),r=s+o;return l},mergeIntoSlice=(t,e,n,o)=>{let r=n[n.length-1],{position:s,word:l}=r;const a=[];let c=0;for(;s+l.length<=e&&0!==n.length;){l===o&&c++,a.push({position:s,length:l.length});const t=s+l.length;n.pop();for(let e=n.length-1;e>=0&&(r=n[e],s=r.position,l=r.word,!(t<=s));e--)n.pop()}return{hits:a,start:t,end:e,searchTextCount:c}},highlightKeyword=(n,e)=>{let o="",r=e.start;return e.hits.forEach(e=>{o+=n.substring(r,e.position);const t=e.position+e.length;o+=`<b class="search-keyword">${n.substring(e.position,t)}</b>`,r=t}),o+=n.substring(r,e.end),o},renderSearchResult=n=>{if(!t||!n)return;const{resultContent:o}=getSearchDom();if(!o)return;const h=n.value.trim().toLowerCase(),u=h.split(/[-\s]+/);u.length>1&&u.push(h);const d=[];if(h.length>0&&e.forEach(({title:o,content:r,url:s})=>{const l=o.toLowerCase(),t=r.toLowerCase();let a=[],c=[],i=0;if(u.forEach(e=>{a=a.concat(getIndexByWord(e,l,!1)),c=c.concat(getIndexByWord(e,t,!1))}),a.length>0||c.length>0){const l=a.length+c.length;[a,c].forEach(e=>{e.sort((e,t)=>t.position!==e.position?t.position-e.position:e.word.length-t.word.length)});const u=[];if(0!==a.length){const r=mergeIntoSlice(0,o.length,a,h);i+=r.searchTextCountInSlice,u.push(r)}let n=[];for(;0!==c.length;){const o=c[c.length-1],{position:s,word:l}=o;let e=s-20,t=s+80;e<0&&(e=0),t<s+l.length&&(t=s+l.length),t>r.length&&(t=r.length);const a=mergeIntoSlice(e,t,c,h);i+=a.searchTextCountInSlice,n.push(a)}n.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start);const e=parseInt(theme.navbar.search.top_n_per_article?theme.navbar.search.top_n_per_article:1,10);e>=0&&(n=n.slice(0,e));let t="";0!==u.length?t+=`<li><a href="${s}" class="search-result-title">${highlightKeyword(o,u[0])}</a>`:t+=`<li><a href="${s}" class="search-result-title">${o}</a>`,n.forEach(e=>{t+=`<a href="${s}"><p class="search-result">${highlightKeyword(r,e)}...</p></a>`}),t+="</li>",d.push({item:t,id:d.length,hitCount:l,searchTextCount:i})}}),1===u.length&&""===u[0])o.innerHTML='<div id="no-result"><i class="fa-solid fa-magnifying-glass fa-5x"></i></div>';else if(0===d.length)o.innerHTML='<div id="no-result"><i class="fa-solid fa-box-open fa-5x"></i></div>';else{d.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id);let t='<ul class="search-result-list">';d.forEach(e=>{t+=e.item}),t+="</ul>",o.innerHTML=t,window.pjax&&window.pjax.refresh(o)}},handleInput=e=>{e.target.matches(".search-input")&&renderSearchResult(e.target)},handleClick=e=>{if(e.target.closest(".search-popup-trigger"))return void(()=>{const{overlay:e,searchInputDom:n}=getSearchDom();e&&n&&(document.body.style.overflow="hidden",e.classList.add("active"),setTimeout(()=>n.focus(),500),t||fetchData())})();const n=e.target.closest(".search-pop-overlay");if(n&&e.target===n)closePopup();else if(e.target.closest(".search-input-field-pre")){const{searchInputDom:t}=getSearchDom();t&&(t.value="",t.focus(),renderSearchResult(t))}else e.target.closest(".popup-btn-close")&&closePopup()},handleKeyup=e=>{"Escape"===e.key&&closePopup()};export const initLocalSearchGlobals=({signal:e}={})=>{ensureSearchPath()?s||(s=!0,e?(document.addEventListener("input",handleInput,{signal:e}),document.addEventListener("click",handleClick,{signal:e}),window.addEventListener("keyup",handleKeyup,{signal:e})):(document.addEventListener("input",handleInput),document.addEventListener("click",handleClick),window.addEventListener("keyup",handleKeyup))):r||(console.warn("`hexo-generator-searchdb` plugin is not installed!"),r=!0)};export const initLocalSearchPage=()=>{ensureSearchPath()?(closePopup(),theme.navbar?.search?.preload&&fetchData()):r||(console.warn("`hexo-generator-searchdb` plugin is not installed!"),r=!0)};