const e=new WeakSet,getBaseWidth=()=>window.innerWidth>=768?255:150,ensureImageLoaded=e=>{if(!e||!e.hasAttribute("lazyload"))return;const t=e.getAttribute("data-src");t&&(e.src=t),e.removeAttribute("lazyload"),delete e.dataset.redefineLazyloadObserved};export default function initMasonry({signal:d}={}){const r=document.querySelector("#masonry-container");if(!r)return;if(e.has(r))return;if(e.add(r),"undefined"==typeof MiniMasonry)return void console.error("MiniMasonry is not available.");const t=document.querySelector("#masonry-loadmore"),n=document.querySelector("#masonry-sentinel"),i=r.dataset.masonryDataUrl||`${(()=>{if("undefined"==typeof window)return"/";const e=window.config?.root||"/";return e.endsWith("/")?e:`${e}/`})()}masonry/data.json`,a=Number.parseInt(window.theme?.page_templates?.masonry?.batch_size,10),s=Number.parseInt(window.theme?.page_templates?.masonry?.initial_batch_size,10);if(Number.isFinite(a)||console.warn("[redefine] page_templates.masonry.batch_size is missing."),Number.isFinite(s)||console.warn("[redefine] page_templates.masonry.initial_batch_size is missing."),!i)return void console.warn("Masonry data url is missing.");const o=new MiniMasonry({baseWidth:getBaseWidth(),container:r,gutterX:10,gutterY:10,surroundingGutter:!1}),l=(e=>{let t=null;return()=>{null===t&&(t=window.requestAnimationFrame(()=>{t=null,e()}))}})(()=>{o.layout()});let c=[],m=0,u=!1;const g=Number.isFinite(s)?Math.max(1,s):24,h=Number.isFinite(a)?Math.max(1,a):12,f="undefined"!=typeof IntersectionObserver,y=f?new IntersectionObserver(e=>{e.forEach(e=>{if(!e.isIntersecting)return;const t=e.target;y.unobserve(t),ensureImageLoaded(t)})},{rootMargin:"200px 0px",threshold:.1}):null,b=e=>{t&&t.classList.toggle("is-hidden",!e)},p=e=>{if(d?.aborted||!r.isConnected)return!1;const t=c.slice(m,m+e);if(0===t.length)return!1;const n=document.createDocumentFragment();return t.forEach(e=>{n.appendChild((e=>{const t=document.createElement("div");t.className="masonry-item";const n=document.createElement("div");n.className="image-container";const r=Number.parseInt(e.width,10),i=Number.parseInt(e.height,10),a=Number.isFinite(r)&&Number.isFinite(i)&&r>0&&i>0;a&&(n.classList.add("has-ratio"),n.style.setProperty("--masonry-aspect-ratio",`${r} / ${i}`));const s=document.createElement("img");s.className="masonry-img is-loading",s.alt=e.title||"",a&&(s.width=r,s.height=i),s.decoding="async",s.loading="lazy",s.setAttribute("lazyload",""),s.setAttribute("data-src",e.image),s.src="data:image/gif;base64,R0lGODlhAQABAAAAACw=",s.dataset.exif=e?.exif?"true":"false";const o=()=>{s.hasAttribute("lazyload")||(s.classList.remove("is-loading"),a||l())};if(d?(s.addEventListener("load",o,{signal:d}),s.addEventListener("error",o,{signal:d})):(s.addEventListener("load",o),s.addEventListener("error",o)),y?y.observe(s):ensureImageLoaded(s),n.appendChild(s),e.title){const d=document.createElement("div");d.className="image-title",d.textContent=e.title,n.appendChild(d)}if(e.description){const d=document.createElement("div");d.className="image-description",d.textContent=e.description,n.appendChild(d)}return t.appendChild(n),t})(e))}),r.appendChild(n),m+=t.length,l(),m<c.length},w=n&&f?new IntersectionObserver(e=>{e.some(e=>e.isIntersecting)&&(()=>{if(u)return;if(d?.aborted||!r.isConnected)return;u=!0,b(!0);const e=p(h);u=!1,b(!1),!e&&n&&w&&(w.disconnect(),n.remove())})()},{rootMargin:"200px 0px",threshold:.1}):null,v=()=>{o.conf.baseWidth=getBaseWidth(),l()};d?(window.addEventListener("resize",v,{signal:d}),d.addEventListener("abort",()=>{y?.disconnect(),w?.disconnect()})):window.addEventListener("resize",v);(async()=>{try{const e=await fetch(i,d?{signal:d}:void 0);if(!e.ok)throw new Error(`Request failed with status ${e.status}`);c=await e.json()}catch(e){if(d?.aborted||"AbortError"===e?.name)return;return console.error("Failed to load masonry data:",e),void(n&&n.remove())}if(Array.isArray(c)&&0!==c.length){if(!d?.aborted&&r.isConnected)if(p(g),r.classList.remove("min-h-screen!"),m<c.length)if(n&&w)w.observe(n);else for(;m<c.length;)p(h);else n&&n.remove()}else n&&n.remove()})()}