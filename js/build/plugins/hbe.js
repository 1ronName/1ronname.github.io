export function initHBE(){const i=window.crypto||window.msCrypto,a=window.localStorage,c="hexo-blog-encrypt:#"+window.location.pathname,s=t("too young too simple"),l=t("sometimes naive!"),n=document.getElementById("hexo-blog-encrypt"),r=n.dataset.wpm,d=n.dataset.whm,e=n.getElementsByTagName("script").hbeData,u=e.innerText,y=e.dataset.hmacdigest;function h(e){return new Uint8Array(e.match(/[\da-f]{2}/gi).map(e=>parseInt(e,16)))}function t(e){for(var t=e.length,n=0,r=new Array,o=0;o<t;){var a=e.codePointAt(o);a<128?(r[n++]=a,o++):a>127&&a<2048?(r[n++]=a>>6|192,r[n++]=63&a|128,o++):a>2047&&a<65536?(r[n++]=a>>12|224,r[n++]=a>>6&63|128,r[n++]=63&a|128,o++):(r[n++]=a>>18|240,r[n++]=a>>12&63|128,r[n++]=a>>6&63|128,r[n++]=63&a|128,o+=2)}return new Uint8Array(r)}function m(e){if("object"!=typeof e||null===e||"number"!=typeof e.byteLength)throw new TypeError("Expected input to be an ArrayBuffer");for(var t,n=new Uint8Array(e),r="",o=0;o<n.length;o++)r+=1===(t=n[o].toString(16)).length?"0"+t:t;return r}async function f(e){let t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll("script").forEach(async e=>{e.replaceWith(await async function e(t){let n=document.createElement("script");return["type","text","src","crossorigin","defer","referrerpolicy"].forEach(e=>{t[e]&&(n[e]=t[e])}),n}(e))}),t}async function p(e,t,o){let n=h(u);return await i.subtle.decrypt({name:"AES-CBC",iv:t},e,n.buffer).then(async e=>{const t=(new TextDecoder).decode(e);if(!t.startsWith("<hbe-prefix></hbe-prefix>"))throw"Decode successfully but not start with KnownPrefix.";const n=document.createElement("button");n.textContent="Encrypt again",n.type="button",n.classList.add("hbe-button"),n.addEventListener("click",()=>{window.localStorage.removeItem(c),window.location.reload()}),document.getElementById("hexo-blog-encrypt").style.display="inline",document.getElementById("hexo-blog-encrypt").innerHTML="",document.getElementById("hexo-blog-encrypt").appendChild(await f(t)),document.getElementById("hexo-blog-encrypt").appendChild(n),document.querySelectorAll("img").forEach(e=>{e.getAttribute("data-src")&&!e.src&&(e.src=e.getAttribute("data-src"))}),window.dispatchEvent(new CustomEvent("redefine:page:refresh"));var r=new Event("hexo-blog-decrypt");return window.dispatchEvent(r),await async function e(t,n){const r=(new TextEncoder).encode(n);let o=h(y);const a=await i.subtle.verify({name:"HMAC",hash:"SHA-256"},t,o,r);return console.log(`Verification result: ${a}`),a||(alert(d),console.log(`${d}, got `,o," but proved wrong.")),a}(o,t)}).catch(e=>(alert(r),console.log(e),!1))}!function e(){const t=JSON.parse(a.getItem(c));if(t){console.log(`Password got from localStorage(${c}): `,t);const s=h(t.iv).buffer,l=t.dk,n=t.hmk;i.subtle.importKey("jwk",l,{name:"AES-CBC",length:256},!0,["decrypt"]).then(t=>{i.subtle.importKey("jwk",n,{name:"HMAC",hash:"SHA-256",length:256},!0,["verify"]).then(e=>{p(t,s,e).then(e=>{e||a.removeItem(c)})})})}n.addEventListener("keydown",async o=>{if(o.isComposing||"Enter"===o.key){const o=document.getElementById("hbePass").value,e=await function e(t){let n=new TextEncoder;return i.subtle.importKey("raw",n.encode(t),{name:"PBKDF2"},!1,["deriveKey","deriveBits"])}(o),t=await function e(t){return i.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:s.buffer,iterations:1024},t,{name:"HMAC",hash:"SHA-256",length:256},!0,["verify"])}(e),n=await function e(t){return i.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:s.buffer,iterations:1024},t,{name:"AES-CBC",length:256},!0,["decrypt"])}(e),r=await function e(t){return i.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:l.buffer,iterations:512},t,128)}(e);p(n,r,t).then(e=>{console.log(`Decrypt result: ${e}`),e&&i.subtle.exportKey("jwk",n).then(n=>{i.subtle.exportKey("jwk",t).then(e=>{const t={dk:n,iv:m(r),hmk:e};a.setItem(c,JSON.stringify(t))})})})}})}()}