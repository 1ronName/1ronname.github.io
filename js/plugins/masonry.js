const initializedContainers=new WeakSet;const getRoot=()=>{if(typeof window==="undefined"){return"/"}const e=window.config?.root||"/";return e.endsWith("/")?e:`${e}/`};const getBlankPlaceholderSrc=()=>"data:image/gif;base64,R0lGODlhAQABAAAAACw=";const getBaseWidth=()=>{const e=window.innerWidth;return e>=768?255:150};const throttleFrame=e=>{let t=null;return()=>{if(t!==null){return}t=window.requestAnimationFrame(()=>{t=null;e()})}};const ensureImageLoaded=e=>{if(!e||!e.hasAttribute("lazyload")){return}const t=e.getAttribute("data-src");if(t){e.src=t}e.removeAttribute("lazyload");delete e.dataset.redefineLazyloadObserved};export default function initMasonry({signal:l}={}){const i=document.querySelector("#masonry-container");if(!i){return}if(initializedContainers.has(i)){return}initializedContainers.add(i);if(typeof MiniMasonry==="undefined"){console.error("MiniMasonry is not available.");return}const t=document.querySelector("#masonry-loadmore");const n=document.querySelector("#masonry-sentinel");const r=i.dataset.masonryDataUrl||`${getRoot()}masonry/data.json`;const e=Number.parseInt(window.theme?.page_templates?.masonry?.batch_size,10);const s=Number.parseInt(window.theme?.page_templates?.masonry?.initial_batch_size,10);if(!Number.isFinite(e)){console.warn("[redefine] page_templates.masonry.batch_size is missing.")}if(!Number.isFinite(s)){console.warn("[redefine] page_templates.masonry.initial_batch_size is missing.")}if(!r){console.warn("Masonry data url is missing.");return}const a=new MiniMasonry({baseWidth:getBaseWidth(),container:i,gutterX:10,gutterY:10,surroundingGutter:false});const m=throttleFrame(()=>{a.layout()});let o=[];let d=0;let c=false;const u=Number.isFinite(s)?Math.max(1,s):24;const f=Number.isFinite(e)?Math.max(1,e):12;const g=typeof IntersectionObserver!=="undefined";const h=g?new IntersectionObserver(e=>{e.forEach(e=>{if(!e.isIntersecting){return}const t=e.target;h.unobserve(t);ensureImageLoaded(t)})},{rootMargin:"200px 0px",threshold:.1}):null;const y=e=>{const t=document.createElement("div");t.className="masonry-item";const n=document.createElement("div");n.className="image-container";const i=Number.parseInt(e.width,10);const r=Number.parseInt(e.height,10);const s=Number.isFinite(i)&&Number.isFinite(r)&&i>0&&r>0;if(s){n.classList.add("has-ratio");n.style.setProperty("--masonry-aspect-ratio",`${i} / ${r}`)}const a=document.createElement("img");a.className="masonry-img is-loading";a.alt=e.title||"";if(s){a.width=i;a.height=r}a.decoding="async";a.loading="lazy";a.setAttribute("lazyload","");a.setAttribute("data-src",e.image);a.src=getBlankPlaceholderSrc();a.dataset.exif=e?.exif?"true":"false";const o=()=>{if(a.hasAttribute("lazyload")){return}a.classList.remove("is-loading");if(!s){m()}};if(l){a.addEventListener("load",o,{signal:l});a.addEventListener("error",o,{signal:l})}else{a.addEventListener("load",o);a.addEventListener("error",o)}if(h){h.observe(a)}else{ensureImageLoaded(a)}n.appendChild(a);if(e.title){const d=document.createElement("div");d.className="image-title";d.textContent=e.title;n.appendChild(d)}if(e.description){const c=document.createElement("div");c.className="image-description";c.textContent=e.description;n.appendChild(c)}t.appendChild(n);return t};const b=e=>{if(!t){return}t.classList.toggle("is-hidden",!e)};const p=e=>{if(l?.aborted||!i.isConnected){return false}const t=o.slice(d,d+e);if(t.length===0){return false}const n=document.createDocumentFragment();t.forEach(e=>{n.appendChild(y(e))});i.appendChild(n);d+=t.length;m();return d<o.length};const w=()=>{if(c){return}if(l?.aborted||!i.isConnected){return}c=true;b(true);const e=p(f);c=false;b(false);if(!e&&n&&v){v.disconnect();n.remove()}};const v=n&&g?new IntersectionObserver(e=>{if(e.some(e=>e.isIntersecting)){w()}},{rootMargin:"200px 0px",threshold:.1}):null;const A=()=>{a.conf.baseWidth=getBaseWidth();m()};const E=()=>{i.classList.remove("min-h-screen!")};if(l){window.addEventListener("resize",A,{signal:l});l.addEventListener("abort",()=>{h?.disconnect();v?.disconnect()})}else{window.addEventListener("resize",A)}const z=async()=>{try{const e=await fetch(r,l?{signal:l}:undefined);if(!e.ok){throw new Error(`Request failed with status ${e.status}`)}o=await e.json()}catch(e){if(l?.aborted||e?.name==="AbortError"){return}console.error("Failed to load masonry data:",e);if(n){n.remove()}return}if(!Array.isArray(o)||o.length===0){if(n){n.remove()}return}if(l?.aborted||!i.isConnected){return}p(u);E();if(d<o.length){if(n&&v){v.observe(n)}else{while(d<o.length){p(f)}}}else if(n){n.remove()}};z()}