import{initTocToggle}from"../tools/tocToggle.js";import{getStyleStatus}from"../state/styleStatus.js";let tocState=null;let didInitScroll=false;const registerScrollHandler=t=>{if(didInitScroll||!t){return}didInitScroll=true;window.addEventListener("scroll",()=>{tocState?.updateActiveTOCLink()},{signal:t})};export function initTOC({signal:t}={}){if(t){registerScrollHandler(t)}const l=document.querySelector(".toc-content-container");if(!l){tocState=null;return null}const e=l.querySelectorAll(".post-toc li");const n=initTocToggle();if(e.length===0){n.hideToggle();l.remove();document.querySelectorAll(".toc-marker").forEach(t=>{t.remove()});tocState=null;return null}const o=l.querySelectorAll(".post-toc li a.nav-link");const a={navItems:e,navLinks:o,updateActiveTOCLink(){if(!Array.isArray(a.sections))return;let t=a.sections.findIndex(t=>{return t&&t.getBoundingClientRect().top-100>0});if(t===-1){t=a.sections.length-1}else if(t>0){t--}this.activateTOCLink(t)},registerTOCScroll(){a.sections=[...a.navLinks].map(t=>{const e=document.getElementById(decodeURI(t.getAttribute("href")).replace("#",""));return e})},activateTOCLink(t){const e=a.navLinks[t];if(!e||e.classList.contains("active-current"))return;l.querySelectorAll(".active").forEach(t=>{t.classList.remove("active","active-current")});e.classList.add("active","active-current");const n=l.getBoundingClientRect().top;const o=l.offsetHeight>window.innerHeight?(l.offsetHeight-window.innerHeight)/2:0;const i=e.getBoundingClientRect().top-n;const c=Math.max(document.documentElement.clientHeight,window.innerHeight||0);const r=i-c/2+e.offsetHeight/2-o;const s=l.scrollTop+r;l.scrollTo({top:s,behavior:"smooth"})},showTOCAside(){const t=()=>{const t=getStyleStatus();const e="isOpenPageAside";if(t&&t.hasOwnProperty(e)){n.pageAsideHandleOfTOC(t[e])}else{n.pageAsideHandleOfTOC(true)}};const e="init_open";if(theme.articles.toc.hasOwnProperty(e)){theme.articles.toc[e]?t():n.pageAsideHandleOfTOC(false)}else{t()}}};a.showTOCAside();a.registerTOCScroll();a.updateActiveTOCLink();tocState=a;return a}